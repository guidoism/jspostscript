<style type="text/css" media="screen">
 #editor { 
     position: absolute;
     top: 600;
     right: 0;
     bottom: 0;
     left: 0;
 }
</style>

<canvas id="canvas" width="700" height="500"></canvas>
<div id="editor">    5 100 moveto
    (The fox went to find the fjord.) show
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/voca/1.4.0/voca.min.js"></script>
<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
 var canvas = document.getElementById('canvas');
 var c = canvas.getContext('2d');

 if (window.devicePixelRatio) {
     var canvasWidth = $(canvas).attr('width');
     var canvasHeight = $(canvas).attr('height');
     var canvasCssWidth = canvasWidth;
     var canvasCssHeight = canvasHeight;
     $(canvas).attr('width', canvasWidth * window.devicePixelRatio);
     $(canvas).attr('height', canvasHeight * window.devicePixelRatio);
     $(canvas).css('width', canvasCssWidth);
     $(canvas).css('height', canvasCssHeight);
     c.scale(window.devicePixelRatio, window.devicePixelRatio);
 }

 $( document ).ready(function() {
     c.font = '48px Minion Pro';

     var _x = 0;
     var _y = 0;
     var ostack = [];
     var pop = function() { return ostack.pop() };

     var code = {
	 "show": function(x, y) { c.fillText(pop(), x, y); },
	 "moveto": function(x, y) { _y = pop(); _x = pop(); },
     };

     var editor = ace.edit("editor");
     editor.setTheme("ace/theme/solarized_dark");
     editor.session.setMode("ace/mode/forth");
     editor.commands.addCommand({
	 name: 'myCommand',
	 bindKey: {win: 'Ctrl-R',  mac: 'Ctrl-R'},
	 exec: function(editor) {
	     var lines = editor.session.getDocument().getLines(0, 1);
	     //console.log(lines)
	     for (let s of lines) {
		 s = v.trim(s);
		 if (v.isBlank(s)) { console.log('Skipping'); continue }

		 console.log('Parsing: "' + s + '"')
		 var t = ''
		 let state = 0;
		 let parens = 0;
		 for (let c of s) {
		     //console.log('parens ' + parens)
		     if (c === '(') { parens = parens + 1; continue }
		     if (c === ')') {
			 parens = parens - 1
			 ostack.push(t)
			 t = ''
			 continue
		     }
		     if (parens > 0) { t = t + c; }
		     else {
			 if (v.isBlank(c) && !v.isBlank(t)) { console.log('defining: "' + t + '"'); ostack.push(t); t = '' }
			 if (v.isDigit(c)) { t = t + c; state = 1 }
			 if (v.isAlpha(c)) { t = t + c; state = 2 }
		     }
		 }

		 console.log(v.sprintf('x = %d, y = %d', _x, _y))
		 console.log('Stack: ' + ostack)
		 console.log('Code: ' + code[t])
		 // TODO make sure there's nothing blank in the stack
		 code[t](_x, _y)
	     }

	 },
	 readOnly: true
     });

 });
</script>

<script>
