<style type="text/css" media="screen">
 #editor { 
     position: absolute;
     top: 600;
     right: 0;
     bottom: 0;
     left: 0;
 }
</style>

<canvas id="canvas" width="700" height="500"></canvas>
<div id="editor">    5 200 moveto
    (The fox went to find the fjord.) show
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/voca/1.4.0/voca.min.js"></script>
<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://unpkg.com/ohm-js@0.13.1/dist/ohm.min.js"></script>

<script>
 var canvas = document.getElementById('canvas');
 var c = canvas.getContext('2d');

 if (window.devicePixelRatio) {
     var canvasWidth = $(canvas).attr('width');
     var canvasHeight = $(canvas).attr('height');
     var canvasCssWidth = canvasWidth;
     var canvasCssHeight = canvasHeight;
     $(canvas).attr('width', canvasWidth * window.devicePixelRatio);
     $(canvas).attr('height', canvasHeight * window.devicePixelRatio);
     $(canvas).css('width', canvasCssWidth);
     $(canvas).css('height', canvasCssHeight);
     c.scale(window.devicePixelRatio, window.devicePixelRatio);
 }

 let parser = ohm.grammar(`
Postscript {
  Exp             = Pexp+
  Pexp            = word | operator | number | string
  word            = "/" letter+
  operator        = letter+
  number          = digit+
  string          = "(" not_right_paren+ ")"
  not_right_paren = escaped_paren | ~")" any
  escaped_paren   = "\\\\" ")"
}
 `);

 $( document ).ready(function() {
     c.font = '48px Minion Pro';

     var _x = 0;
     var _y = 0;
     var ostack = [];
     var pop = function() { return ostack.pop() };
     var code = {
	 "show": function(x, y) { c.fillText(pop(), x, y); },
	 "moveto": function(x, y) { _y = pop(); _x = pop(); },
     };

     let semantics = parser.createSemantics()
     semantics.addOperation('eval', {
	 Exp: e => e.eval(),
	 word: (left, right) => ostack.push(left.eval() + right.eval()),
	 operator: e => code[e.sourceString](_x, _y),
	 number: e => ostack.push(e.sourceString),
	 string: (left, e, right) => ostack.push(e.sourceString),
     })
     semantics(parser.match('100 99 moveto')).eval()
     console.log(`${_x}, ${_y}`)
     console.log(semantics(parser.match('(this is a string.)')).eval())
     console.log(ostack)
     console.log(semantics(parser.match('show')).eval())
     console.log(ostack)
     
     var editor = ace.edit("editor");
     editor.setTheme("ace/theme/solarized_dark");
     editor.session.setMode("ace/mode/forth");
     editor.commands.addCommand({
	 name: 'myCommand',
	 bindKey: {win: 'Ctrl-R',  mac: 'Ctrl-R'},
	 exec: function(editor) {
	     var lines = editor.session.getDocument().getLines(0, 1);
	     lines.map(s => semantics(parser.match(s)).eval())
	 },
	 readOnly: true
     });

 });
</script>

<script>
